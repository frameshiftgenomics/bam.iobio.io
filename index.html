<!DOCTYPE html>
<html lang="en">
    <head>
        <link href="css/flat-ui.css" rel="stylesheet">
        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-47481907-2', 'iobio.io');
          ga('send', 'pageview');

        </script>

        <script src="js/jquery.min.js"></script>
        <script src="js/class.js"></script>
        <script src="js/rdp.js"></script>
        <script src="js/d3.v3.min.js"></script>
        <script src="js/queue.min.js"></script>
        <script src="js/donut.d3.js"></script>
        <script src="js/histogram.d3.js"></script>
        <script src="js/histogramViewFinder.d3.js"></script>
        <script src="js/movingLine.d3.js"></script>
        <script src="js/nprogress.js"></script>
        <script src="js/bam.d3.js"></script>
        <script src="js/bam.iobio.js/bam.iobio.js"></script>
        <script src="js/bam.iobio.js/bam.js"></script>
        <script src="js/bam.iobio.js/bin.js"></script>
        <script src="js/bam.iobio.js/inflate.js"></script>

        <script src="js/iobio.viz.js"></script>
        <script src="js/iobio.js"></script>
        <link href='http://fonts.googleapis.com/css?family=Quicksand:300,400' rel='stylesheet' type='text/css'>
        <link href='http://fonts.googleapis.com/css?family=Overlock+SC' rel='stylesheet' type='text/css'>
        <link href='css/nprogress.css' rel='stylesheet' type='text/css'>
        <link href='css/site.css' rel='stylesheet' type='text/css'>
        <link href='css/iobio.viz.min.css' rel='stylesheet' type='text/css'>
        <!-- <link href='http://fonts.googleapis.com/css?family=Quicksand:300,400' rel='stylesheet' type='text/css'> -->

        <script>
            $(document).ready( function(){
                // var is_chrome = navigator.userAgent.toLowerCase().indexOf('chrome') > -1;
                // if (!is_chrome) alert("Warning! This site requires Google Chrome to function properly");
                // check for window.requestAnimation frame and add it if it's not here.
                (function () {
                  var lastTime = 0;
                  var vendors = ['ms', 'moz', 'webkit', 'o'];
                  for(var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
                    window.requestAnimationFrame = window[vendors[x] + 'RequestAnimationFrame'];
                    window.cancelAnimationFrame = window[vendors[x] + 'CancelAnimationFrame'] || window[vendors[x] + 'CancelRequestAnimationFrame'];
                  }
                  if(!window.requestAnimationFrame)
                    window.requestAnimationFrame = function (callback, element) {
                      var currTime = new Date().getTime();
                      var timeToCall = Math.max(0, 16 - (currTime - lastTime));
                      var id = window.setTimeout(function () {
                        callback(currTime + timeToCall);
                      },
                      timeToCall);
                      lastTime = currTime + timeToCall;
                      return id;
                  };
                  if(!window.cancelAnimationFrame)
                    window.cancelAnimationFrame = function (id) {
                      clearTimeout(id);
                  };
                }());

                // $("#read-coverage-distribution input[type='checkbox']").change(function(){
                //     if ($(this).parent().hasClass("checked"))
                //         window.readCoverageDistChart(hist2array(window.sampleStats.coverage_hist), { noOutliers : false })
                //     else
                //         window.readCoverageDistChart(hist2array(window.sampleStats.coverage_hist), { noOutliers : true })
                // });

                $("#scale-switch input[type='checkbox']").change(function(){
                  var selection = d3.select('#depth-distribution .chart')

                  if ( $(this).parent().hasClass("checked") )
                    window.readDepthChart.lineChart().y( window.readDepthChart.lineChart().y().exponent(0.5) );
                  else
                    window.readDepthChart.lineChart().y( window.readDepthChart.lineChart().y().exponent(1) );

                  window.readDepthChart(selection, { selected: getSelectedSeqId()});
                })

                $("#length-distribution input[type='checkbox']").change(function(){
                    var outliers = $(this).parent().hasClass("checked");

                    var dataId = $("#length-distribution .chart-chooser .selected").attr("data-id")
                    var h = window.sampleStats[dataId];
                    var d = Object.keys(h).map(function(k) { return  [+k, +h[k]] });
                    var selection = d3.select("#length-distribution-chart")
                    if (!outliers) d = iobio.viz.layout.outlier()(d);
                    selection.datum(d);
                    window.lengthChart(selection, {'outliers':outliers});
                });

                $("#url-input, #bai-url-input").keyup(function(event){
                    if(event.keyCode == 13){
                        $("#bam-url-go-button").click();
                    }
                });

                $('#url-input').focus(function() {
                    if (this.setSelectionRange) {
                        this.setSelectionRange(7, 7);
                    } else if (this.createTextRange) {
                        // IE
                        var range = this.createTextRange();
                        range.collapse(true);
                        range.moveStart('character', 7);
                        range.moveEnd('character', 7);
                        range.select();
                    }
                });

                document.getElementById('file').addEventListener('change', openBamFile, false);
                document.getElementById('bedfile').addEventListener('change', openBedFile, false);


                // initialize charts
                // get height width of histogram charts and set viewboxes
                var width = $("#read-coverage-distribution-chart").width();
                var height = $("#read-coverage-distribution-chart").height();
                var dists = document.getElementsByClassName("focus") // viewboxes need to be set at runtime to get accurate height/width
                for (var i=0; i < dists.length; i++ ) { dists[i].setAttribute('viewBox', "0 0 " + width + " " + height) }

                // get width for main panel depth chart
                var depthChartWidth = $("#depth-distribution .chart").width();
                var pieChooserPadding = 30;
                var pieChooserWidth = Math.min(+$("#piechooser").width(), +$("#piechooser").height() - 0) ;

                var color = d3.scale.category20b();

                var r = pieChooserWidth/2 - pieChooserPadding;

                window.draw = true;

                window.pieChooserChart = iobio.viz.pieChooser()
                    .radius(r)
                    .innerRadius(r*.5)
                    .padding(pieChooserPadding)
                    .color( function(d,i) {
                      return color(d.data.name);
                    })
                    .on("click", function(d,i) {
                      setSelectedSeq(d.data.name);
                    })
                    .on("clickall", function(d,i) {
                      window.readDepthChart.trigger('click', 'all');
                    })
                    .tooltip( function(d) {
                      return d.data.name;
                    });


                // setup read coverage histogram chart
                window.readCoverageChart = iobio.viz.barViewer()
                  .xValue(function(d) { return d[0]; })
                  .yValue(function(d) { return d[1]; })
                  .wValue(function() { return 1; })
                  .height(height)
                  .width(width)
                  .margin({top: 5, right: 20, bottom: 20, left: 50})
                  .sizeRatio(0.8);
                window.readCoverageChart.yAxis().tickFormat(function(d) { return d*100 + '%'});

                window.lengthChart = iobio.viz.barViewer()
                  .xValue(function(d) { return d[0]; })
                  .yValue(function(d) { return d[1]; })
                  .wValue(function() { return 1; })
                  .height(height)
                  .width(width)
                  .margin({top: 5, right: 20, bottom: 20, left: 50})
                  .sizeRatio(0.8);
                window.lengthChart.xAxis().tickFormat(tickFormatter);
                window.lengthChart.yAxis().tickFormat(tickFormatter);

                // setup quality histogram chart
                window.qualityChart = iobio.viz.barViewer()
                    .xValue(function(d) { return d[0]; })
                    .yValue(function(d) { return d[1]; })
                    .wValue(function() { return 1; })
                    .height(height)
                    .width(width)
                    .margin({top: 5, right: 20, bottom: 20, left: 50})
                    .sizeRatio(0.8);
                window.qualityChart.xAxis().tickFormat(tickFormatter);
                window.qualityChart.yAxis().tickFormat(tickFormatter);

                // setup main panel read chart
                var yscale = d3.scale.pow().exponent(1);
                window.readDepthChart = iobio.viz.multiLine()
                  .nameValue(function(d) { return d.name; })
                  .dataValue(function(d) { return d.data; })
                  .xValue(function(d,i) { return d.pos; })
                  .yValue(function(d,i) { return d.depth; })
                  .wValue(function() { return 1; })
                  .transitionDuration(400)
                  .epsilonRate(0.3)
                  .margin({top: 10, right: 0, bottom: 30, left:0})
                  .height(150)
                  .color(function(d,i) {return color(d.name); })
                  .width(depthChartWidth)
                  .on('click', function(d) {
                    var name = d ? d.name : 'all';
                    setSelectedSeq(name);
                  })
                  .brush('brushend', function(b) {
                    var start = parseInt(b.extent()[0]), end = parseInt(b.extent()[1]);
                    if (start != end)
                      setSelectedSeq( window.readDepthChart.getSelected(), start, end );
                    else
                      setSelectedSeq( window.readDepthChart.getSelected() );
                  });

                window.readDepthChart.lineChart().y(yscale);

                // setup donut chart
                // window.sampleDonutChart = donutD3().radius(61).klass("sampleArc");
                window.sampleDonutChart = iobio.viz.pie()
                    .radius(61)
                    .innerRadius(50)
                    .color( function(d,i) { if (i==0) return '#2d8fc1'; else return 'rgba(45,143,193,0.2)'; });

                // hold onto stats
                window.sampleStats = undefined;

                // default sampling values
                window.samplingBinSize = 40000;
                window.binNumber = 20;
                window.binSize = 40000;
                window.sampleMultiplier = 1;
                window.sampleMultiplierLimit = 4;

                window.bam = undefined;
                window.sampling = getUrlParameter('sampling')

                // check if app is triggered from illumina
                var action = getUrlParameter('action')
                if (action == 'trigger') {
                  getIlluminaBamBaiUrls(function(bamUrl, baiUrl) {
                    window.bam = new Bam(bamUrl, { bai: baiUrl});
                    goBam();
                  })
                }

                // check if url is present
                var bamUrl = decodeUrl(getUrlParameter('bam'))
                // check if url to bam file is supplied in url and sample it
                if (bamUrl != undefined) {
                    // remove https if present
                    // if (bamUrl.slice(0,5) == 'https')
                    //   bamUrl = 'http' + bamUrl.slice(5,bamUrl.length);
                    var baiUrl = decodeUrl(getUrlParameter('bai'));
                    if (baiUrl)
                        window.bam = new Bam( bamUrl, {bai: baiUrl} );
                    else
                        window.bam = new Bam( bamUrl );
                    var r = getUrlParameter('region');
                    var region = undefined;
                    if (r != undefined) {
                      if (r.split(":").length == 1)
                        region = { chr: r.split(":")[0]}
                      else
                        region = {
                          chr: r.split(":")[0],
                          start: parseInt(r.split(":")[1].split('-')[0]),
                          end: parseInt(r.split(":")[1].split('-')[1])
                        };
                    }


                    goBam(region);
                }
            });

            function decodeUrl(url) {
              if (url && (url.slice(0,14) == 'https%3A%2F%2F' || url.slice(0,13) == 'http%3A%2F%2F'))
                return decodeURIComponent(url)
              else
                return url;
            }

            function getUrlParameter(sParam) {
                var sPageURL = window.location.search.substring(1);
                var sURLVariables = sPageURL.match(/(?:[^&"]+|"[^"]*")+/g) || [];
                for (var i = 0; i < sURLVariables.length; i++)
                {
                    var sParameterName = sURLVariables[i].match(/(?:[^="]+|"[^"]*")+/g);
                    if (sParameterName[0] == sParam)
                    {
                        return sParameterName[1];
                    }
                }
            }

            function removeBedFile() {
                $("#remove-bedfile-button").css('visibility', 'hidden');
                $("#default-bedfile-button").css('visibility', 'visible');
                $("#add-bedfile-button").css('visibility', 'visible');
                window.bed = undefined;
                goSampling({sequenceNames :  getSelectedSeqIds() });
            }

            function addDefaultBedFile() {
                var bedurl = '/20130108.exome.targets.bed';

                // clear brush on read coverage chart
        	    resetBrush();

                // hide add bed / show remove bed buttons
                $("#add-bedfile-button").css('visibility', 'hidden');
                $("#default-bedfile-button").css('visibility', 'hidden');
                $("#remove-bedfile-button").css('visibility', 'visible');

                // turn on sampling message and off svg
                // turn it on here b\c the bed file is so big it takes a while to download
                $("section#middle svg").css("display", "none");
                $(".samplingLoader").css("display", "block");


                // grab bed from url
                $.ajax({
                    // XDomainRequest protocol (IE 8 & 9) must be the same scheme as the calling page
                    url: bedurl,
                    dataType: 'text'
                }).done(function (data) {
                    data = data.replace(/chr/g, '');
                    window.bed = data;
                    goSampling({sequenceNames : getSelectedSeqIds() });
                });

            }

            function openBedFile(event) {

                if (event.target.files.length != 1) {
                   alert('must select a .bed file');
                   return;
                }

                // check file extension
                var fileType = /[^.]+$/.exec(event.target.files[0].name)[0];
                if (fileType != 'bed')  {
            	    alert('must select a .bed file');
            	    return;
        	    }
        	    // clear brush on read coverage chart
        	    resetBrush();

                // hide add bed / show remove bed buttons
                $("#add-bedfile-button").css('visibility', 'hidden');
                $("#default-bedfile-button").css('visibility', 'hidden');
                $("#remove-bedfile-button").css('visibility', 'visible')

	            // read bed file and store
	            var reader = new FileReader();
                reader.onload = function(theFile) {
                    window.bed = this.result;
                    goSampling({sequenceNames : getSelectedSeqIds() });
                }
                reader.readAsText(event.target.files[0])
              }

            function openBamFile(event) {

                if (event.target.files.length != 2) {
                   alert('must select both a .bam and .bai file');
                   return;
                }

                var fileType0 = /[^.]+$/.exec(event.target.files[0].name)[0];
                var fileType1 = /[^.]+$/.exec(event.target.files[1].name)[0];

                if (fileType0 == 'bam' && fileType1 == 'bai') {
            	    bamFile = event.target.files[0];
            	    baiFile = event.target.files[1];
            	 } else if (fileType1 == 'bam' && fileType0 == 'bai') {
            	    bamFile = event.target.files[1];
            	    baiFile = event.target.files[0];
            	 } else {
            	    alert('must select both a .bam and .bai file');
            	 }

                 window.bam = new Bam( bamFile, { bai: baiFile });
                 goBam();
              }

             function goBam(region) {
                 $("#selectData").css("display", "none");
                 $("#showData").css("visibility", "visible");

                 // get read depth
                 window.bam.estimateBaiReadDepth(function(id,points, done){
                     // setup first time and sample

                     if ( Object.keys(window.bam.readDepth).length == 1) {
                         // turn off read depth loading msg
                         $("#readDepthLoadingMsg").css("display", "none");
                         // turn on sampling message
                         $(".samplingLoader").css("display", "block");

                     }

                     var allPoints = Object.keys(window.bam.readDepth)
                      .filter(function(key) {
                        if (key.substr(0,4) == 'GL00')
                          return false
                        if (window.bam.readDepth[key].length > 0)
                          return  true
                      })
                      .map(function(key) {
                        return {"name" : key, "data" : window.bam.readDepth[key] }
                     })

                    draw = true;

                    var selection = d3.select('#depth-distribution .chart').datum(allPoints);

                    var pie = d3.layout.pie()
                       .sort(null)
                       .value(function(d,i) {return d.data.length });

                    var pieSelection = d3.select('#piechooser').datum( pie(allPoints) )

                    if (allPoints.length > 50) {
                      $('#piechooser svg').css('visibility', 'hidden');
                      $('.too-many-refs').css('display', 'block')
                      draw = false;
                    }

                    if(draw) (window.pieChooserChart(pieSelection));
                    if (region && region.chr != 'all') {
                      if(draw) window.readDepthChart(selection, {selected:region.chr, noLine:!done});
                    }
                    else {
                      if(draw) window.readDepthChart(selection, {noLine:!done});
                    }

                    $('#reference-select')
                      .append($("<option></option>")
                        .attr("value", id)
                        .text(id));

                     var start = region ? region.start : undefined;
                     var end = region ? region.end : undefined;
                     if (region && region.chr == id ) {
                         setSelectedSeq( id, start, end);
                         //window.readDepthChart(selection, {selected:id});
                     }

                     if ( (done && !region) || (done && region && region.chr == 'all') ) {
                        setSelectedSeq( 'all' , start, end );
                     }

                     var totalPoints = allPoints.reduce(function(acc,val) { return acc + val.data.length  },0)
                     if (done && totalPoints <= 1) {
                        $('#not_enough_data').css('display','block');
                     }
                 });

             }

            function resetRegionStats() {
                window.regionStats = {'Total reads' : {number : 0}};
            }

            function resetBrush() {
                var brush = window.readDepthChart.brush();
                var g = d3.selectAll("#depth-distribution .iobio-brush")
                brush.clear();
                brush(g);
                // remove brush region from url
                setUrlRegion({chr:getSelectedSeqId()});
                // no need to trigger event? since setSelected sq will do it
                //brush.event(g);
            }


            function updateTotalReads(totalReads) {
                // update total reads
                var reads = shortenNumber( totalReads );
                $("#total-reads>#value").html( reads[0] );
                $("#total-reads>#base>#number").html( reads[1] || "" );
            }

            function setSelectedSeq(selected, start, end) {
                if (selected == 'all') {
                  var seqDataIds = Object.keys(window.bam.readDepth)
                        .filter(function(key) {
                            if (key.substr(0,4) == 'GL00')
                              return false
                            if (window.bam.readDepth[key].length > 0)
                              return  true
                          })
                  setTimeout(function() {
                    window.pieChooserChart.clickAllSlices(d3.selectAll('#piechooser .arc')[0]);
                  }, 2000);
                }
                else {
                  var seqDataIds = [selected];
                  $('#piechooser .arc').each(function(i,d) {
                    if (d3.select(d).datum().data.name == selected)
                      setTimeout(function() {window.pieChooserChart.clickSlice(i);}, 2000);

                  });

                }

                // window.readDepthChart.trigger('click', selected);
                if(draw) window.readDepthChart.setSelected(selected);

                $("#reference-select").val(selected);

                // reset brush
                resetBrush();
                setUrlRegion({chr:selected, 'start':start, 'end':end });
               // start sampling
               if(start!= undefined && end!=undefined) {
                 goSampling({ sequenceNames:seqDataIds, 'start':start, 'end':end });
                 setTimeout(function() { setBrush(start,end)}, 200);
               } else {
                 goSampling({ sequenceNames:seqDataIds});
               }
            }

            function setBrush(start,end) {
              var brush = window.readDepthChart.brush();
                 // // set brush region
              d3.select("#depth-distribution .iobio-brush").call(brush.extent([start,end]));
            }

            function resetBrush() { setBrush(0,0); }

            function setUrlRegion(region) {
              if (window.bam.sourceType == 'url' && region != undefined) {
                if (region.start != undefined && region.end != undefined) {
                  var regionStr = region.chr + ':' + region.start + '-' + region.end;
                } else {
                  var regionStr = region.chr;
                }
                var extraParams = '';
                if (window.sampling) extraParams += '&sampling=' + window.sampling
                if (window.bam.baiUri != undefined) {
                  window.history.pushState({'index.html' : 'bar'},null,"?bam=" + encodeURIComponent(window.bam.bamUri) + "&bai=" + encodeURIComponent(window.bam.baiUri) + "&region=" + regionStr + extraParams);

                } else {
                  window.history.pushState({'index.html' : 'bar'},null,"?bam=" + encodeURIComponent(window.bam.bamUri) + "&region=" + regionStr + extraParams);
                }
              }
            }

            function goSampling(options) {
                // add default options
                options = $.extend({
                    exomeSampling : 'checked' == $("#depth-distribution input").attr("checked"),
                    bed : window.bed,
                    onEnd:function(){NProgress.done();}
                },options);

                // turn on sampling message and off svg
                $("section#middle svg").css("display", "none");
                $(".samplingLoader").css("display", "block");
                updateTotalReads(0);
                NProgress.start();
                NProgress.set(0);
                // update selected stats
                window.bam.sampleStats( function(data){
                    // turn off sampling message
                    $(".samplingLoader").css("display", "none");
                    $("section#middle svg").css("display", "block");
                    window.sampleStats = data;
                    // update progress bar
                    if (options.start != null && options.end != null) {
                        var length = options.end - options.start;
                        var percentDone = Math.max(Math.round( ((data.last_read_position-options.start) / length) * 100) / 100,0);
                    } else {
                        var length = window.bam.header.sq.reduce(function(prev,curr) { if (prev)return prev; if (curr.name == options.sequenceNames[0] )return curr; }, false).end;
                        var percentDone = Math.round( (data.last_read_position / length) * 100) / 100;
                    }

                    if (NProgress.status < percentDone) NProgress.set(percentDone);
                    // update charts
                    updatePercentCharts(data, window.sampleDonutChart)
                    updateTotalReads(data.total_reads);
                    updateHistogramCharts(data, undefined, "sampleBar")
                },options);
            }

            function sampleMore() {
                if (window.sampleMultiplier >= window.sampleMultiplierLimit) { alert("You've reached the sampling limit"); return;}
                window.sampleMultiplier += 1;
                var options = {
                    sequenceNames : getSelectedSeqIds() ,
                    binNumber : window.binNumber + parseInt(window.binNumber/4 * window.sampleMultiplier),
                    binSize : window.binSize + parseInt(window.binSize/4 * window.sampleMultiplier)
                }
                if (window.readDepthChart.brush().extent().length != 0 && window.readDepthChart.brush().extent().toString() != "0,0") {
                    options.start = parseInt(window.readDepthChart.brush().extent()[0]);
                    options.end = parseInt(window.readDepthChart.brush().extent()[1]);
                }
                goSampling(options);
            }

            function getSelectedSeqId() {
              return window.readDepthChart.getSelected();
            }

            function getSelectedSeqIds() {
              var selected = window.readDepthChart.getSelected();
              if (selected == 'all') {
                return Object.keys(window.bam.readDepth)
                      .filter(function(key) {
                        if (key.substr(0,4) == 'GL00')
                          return false
                        if (window.bam.readDepth[key].length > 0)
                          return  true
                      })
              } else
                return [selected];
            }

            function updatePercentCharts(stats, donutChart) {
                var pie = d3.layout.pie()
                   .sort(null);
                var value = undefined;

                var selected = getSelectedSeqId();
                var unmappedReads, mappedReads;
                if (selected == 'all') {
                  if (window.bam.readDepth[Object.keys(window.bam.readDepth)[0]].mapped != undefined) {
                    mappedReads = unmappedReads = 0;
                    for ( var id  in window.bam.readDepth) {
                      mappedReads += window.bam.readDepth[id].mapped;
                      unmappedReads += window.bam.readDepth[id].unmapped;
                    }
                    unmappedReads = window.bam.n_no_coor;
                  }
                }
                else {
                  mappedReads = window.bam.readDepth[selected].mapped;
                  unmappedReads = window.bam.readDepth[selected].unmapped;
                }
                var showMappedDataFromIndex = false;
                var brushRange = window.readDepthChart.brush().extent();
                if ( (brushRange == undefined || brushRange.toString() == '0,0' ) && mappedReads != undefined && unmappedReads != undefined) {
                  showMappedDataFromIndex = true;
                  d3.select("#mapped_reads").selectAll('path')
                    .attr('fill', function(d,i) { return i==0 ? 'rgb(9,176,135)' : 'rgba(9,176,135,0.5)' });
                  d3.select('.percent .from-index').style('visibility', 'visible')
                }
                else
                  d3.select('.percent .from-index').style('visibility', 'hidden')

                //update percent charts
                var keys = ['mapped_reads', "proper_pairs", "forward_strands", "singletons", "both_mates_mapped", "duplicates"]
                // var colors = ["rgb(45,143,193)", 'rgb(231, 76, 60)', "rgb(243, 156, 18)", "rgb(155, 89, 182)", "rgb(46, 204, 113)", "rgb(241, 196, 15)"];
                keys.forEach( function(key,i) {
                    var stat = stats[key];
                    if (key == 'mapped_reads' && showMappedDataFromIndex)  {
                      var data = [ mappedReads, unmappedReads ];
                    }
                    else {
                      if (stats['total_reads'] == 0)
                        var data = [ 0, 100 ];
                      else
                        var data = [ stat, stats['total_reads'] - stat ];
                    }

                    var selection = d3.select('#'+key  + ' .chart').datum(pie(data));
                    donutChart(selection);
                });

            }

            function updateHistogramCharts(histograms, otherMinMax, klass) {

                // check if coverage is zero
                if (Object.keys(histograms.coverage_hist).length == 0) histograms.coverage_hist[0] = '1.0';
                // update read coverage histogram
                var d = Object.keys(histograms.coverage_hist).filter(function(i){return histograms.coverage_hist[i] != "0"}).map(function(k) { return [+k, +histograms.coverage_hist[k]] });
                var selection = d3.select("#read-coverage-distribution-chart").datum(d);
                window.readCoverageChart(selection);
                // if (histograms.coverage_hist[0] > 0.65) {
                //     // most likely exome
                //     // exclude <5 values b\c they are not informative dominating the chart
                //     var min = 5;
                //     var max = window.readCoverageChart.globalChart().x().domain()[1];
                //     window.readCoverageChart.setBrush([min, max]);
                // }

                // update read length distribution
                if ($("#length-distribution .selected").attr("data-id") == "frag_hist")
                    var d = Object.keys(histograms.frag_hist).filter(function(i){return histograms.frag_hist[i] != "0"}).map(function(k) { return  [+k, +histograms.frag_hist[k]] });
                else
                    var d = Object.keys(histograms.length_hist).map(function(k) { return  [+k, +histograms.length_hist[k]] });
                // remove outliers if outliers checkbox isn't explicity checked
                var outliers = $("#length-distribution .checkbox").hasClass("checked");
                if (!outliers) d = iobio.viz.layout.outlier()(d);
                var selection = d3.select("#length-distribution-chart").datum(d);
                window.lengthChart( selection );
                // window.lengthChart( selection, {'outliers':outliers} );

                // update map quality distribution
                if ($("#mapping-quality-distribution .selected").attr("data-id") == "mapq_hist")
                    var d = Object.keys(histograms.mapq_hist).map(function(k) { return  [+k, +histograms.mapq_hist[k]] });
                else
                    var d = Object.keys(histograms.baseq_hist).map(function(k) { return  [+k, +histograms.baseq_hist[k]] });
                var selection = d3.select("#mapping-quality-distribution-chart").datum(d);
                window.qualityChart(selection);
            }

            function getIlluminaAccessToken(callback) {
                var basespace = 'nv-dev-new.iobio.io/basespaceauth/';
                var authorization_code = getUrlParameter('authorization_code');
                var cmd = new iobio.cmd(basespace, [authorization_code]);

                cmd.on('data', function(d) {
                    var accessToken = JSON.parse(d).access_token
                    callback(accessToken);
                })
                    .on('error', function(e) { /*console.error(e)*/ ;})
                    .run()
            }

            function getIlluminaBamBaiUrls(callback) {
                var appSessionHref = getUrlParameter('appsessionuri'),
                    apiUrl = "https://api.basespace.illumina.com/";

                getIlluminaAccessToken(function(accessToken) {
                    $.ajax({
                       url: apiUrl + appSessionHref,
                       data: {access_token: accessToken},
                       type: 'GET',
                       contentType: "application/json",
                       dataType: 'json',
                       error: function(error) {
                          console.error(error);
                       }

                    }).done(function(sessionRes) {
                        var bamHref, baiHref;

                        sessionRes.Response.References.forEach(function(ref) {
                            if (ref.Type == 'File' && ref.Rel == 'Input') {
                                if (ref.Content.Name.slice(-3) == 'bam')
                                    bamHref = ref.Content.HrefContent;
                                else if (ref.Content.Name.slice(-3) == 'bai')
                                    baiHref = ref.Content.HrefContent;
                            }
                        })

                        // get bam S3 location
                        $.ajax({
                            url: apiUrl + bamHref,
                            data: {access_token: accessToken, redirect: 'meta'},
                            type: 'GET',
                            contentType: "application/json",
                            dataType: 'json',
                            error: function(error) {
                                console.error(error);
                            }
                        }).done(function(bamRes) {

                            var bamUrl = '"' + bamRes.Response.HrefContent + '"' ;

                            // get bai s3 location
                            $.ajax({
                                url: apiUrl + baiHref,
                                data: {access_token: accessToken, redirect: 'meta'},
                                type: 'GET',
                                contentType: "application/json",
                                dataType: 'json',
                                error: function(error) {
                                    console.error(error);
                                }
                            }).done(function(baiRes) {
                                var baiUrl = '"' + baiRes.Response.HrefContent + '"';
                                callback(bamUrl, baiUrl);
                            })
                        })
                    })
                })
            }


            function toggleChart(elem, chartId) {
                if ($(elem).hasClass("selected")) return;
                // toggle selected
                var pair = [elem, $(elem).siblings()[0]];
                $(pair).toggleClass('selected');

                // redraw chart
                var dataId = elem.getAttribute("data-id")
                // var outlier = elem.getAttribute('data-outlier') === 'true' || elem.getAttribute('data-outlier') == null;
                var h = window.sampleStats[dataId];
                var d = Object.keys(h).map(function(k) { return  [+k, +h[k]] });
                var chartDiv = $(elem).parent().parent().parent();
                var selection = d3.select(chartDiv.find('.chart')[0])
                if ( chartDiv.find(".selected").attr("data-id") == "frag_hist" ) {
                    var outlier = chartDiv.find('.checkbox').hasClass('checked')
                    if (!outlier) d = iobio.viz.layout.outlier()(d);
                }
                selection.datum(d);
                window[chartId](selection);
            }

            function shortenNumber(num) {
                if(num.toString().length <= 3)
                    return [num];
                else if (num.toString().length <= 6)
                    return [Math.round(num/1000), "thousand"];
                else
                    return [Math.round(num/1000000), "million"];
            }

            // function hist2array(hist) {
            //     var a = [];
            //     for ( var i in hist) {
            //        a.push([ i,hist[i] ]);
            //         // var position = i;
            //         //                     var instances = hist[i];
            //         // for ( var j=0; j < instances; j++)
            //         //                         a.push( parseInt(position) );
            //     }
            //     return a;
            // }

            function displayBamUrlBox() {
                $('#bam-url').css('visibility','visible');
                $('#info').css('visibility', 'hidden');
                $("#bam-url").children("input").first().focus();
            }

            function openBamUrl() {
                var url = $("#url-input").val();
                var baiUrl = $("#bai-url-input").val()
                // remove https if present
                // if (url.slice(0,5) == 'https')
                //   url = 'http' + url.slice(5,url.length);


                if( baiUrl != '' ) {
                  window.history.pushState({'index.html' : 'bar'},null,"?bam=" + encodeURIComponent(url) + "&bai=" + encodeURIComponent(baiUrl));
                  window.bam = new Bam(url, { bai: baiUrl});
                } else {
                  window.history.pushState({'index.html' : 'bar'},null,"?bam=" + encodeURIComponent(url));
                  window.bam = new Bam( url );
                }
                goBam();
            }

            function tickFormatter (d) {
              if ((d / 1000000) >= 1)
                d = d / 1000000 + "M";
              else if ((d / 1000) >= 1)
                d = d / 1000 + "K";
              return d;
           }

        </script>
    </head>
    <body>
        <header>
            <a href="http://bam.iobio.io">bam<span style="color:rgb(200,200,200)">.iobio.io</span></a>
            <div style="float:right" class="iobio-project" style="padding-top:20px">
                <a href="http://iobio.io" style="margin: 0px 5px 0px 5px;">an iobio project</a>
            </div>
        </header>
        <div id='maintenance_mode' style="display: none; text-align: center; width:80%; font-family: arial; font-size: 30px; margin: 100px auto;">
          We are currently undergoing maintenance please check back in a few minutes
        </div>
        <div id="content">
          <div id="selectData">
              <div style="width:700px; margin-left:auto; margin-right:auto; margin-top: 100px">
                  <div style="margin-left:auto;margin-right:auto;font-size: 28px; color: rgb(110,110,110); margin-bottom:70px">
                      examine your sequence alignment file in seconds
                  </div>

                  <div class="file" onClick="$('#bam-url').css('visibility', 'hidden')">
                      <input type="file" name="files[]" id="file"  multiple />
                      <label class="file-button" for="file" >choose bam file</label>
                  </div>
                  <div class="file-button" style="text-align:center" onClick="displayBamUrlBox()">choose bam url</div>
                  <div style="clear:both"></div>
                  <div id="info">
                      <ul>
                              <li><a href="http://www.nature.com/nmeth/journal/v11/n12/full/nmeth.3174.html">Publication</a></li>
                              <li><a href="help.html">File Requirements</a></li>
                              <li><a href="license.html">License</a></li>
                              <li><a href="images/browserCompatability.png">Compatible Browsers</a></li>
                      </ul>
                  </div>
              </div>
              <div id='bam-url' style="margin-top:-21px;width:700px;margin-left:auto;margin-right:auto;visibility:hidden" class="arrow_box">
                  <input id="url-input" value="http://s3.amazonaws.com/iobio/NA12878/NA12878.autsome.bam" ></input>
                  <input id="bai-url-input" placeholder="BAI URL (optional)" ></input>
                  <button id="bam-url-go-button" onClick="openBamUrl()">Go</button>
              </div>
              <div style="margin: 50px auto 0px auto; font-size: 23px; width: 600px; text-align:center;  color: rgb(110,110,110)">
                  <div>for variant files check out <a href="http://vcf.iobio.io">vcf.iobio</a></div>
              </div>

              <div id="footer">
                  <div class="logos">
                      <div style="position:absolute; left: 100px; top:4px; font-size:50px;font-family:'Overlock SC', cursive;">Marthlab</div>
                      <img src="images/ustar-ucgd-logo.jpg" style="height:60px;"/>
                      <a href="http://www.genetics.utah.edu/"><img src="images/genetics_mainlogo3_lrg.png" style="height:50px;position:absolute;right:0px;top:7px"/></a>
                  </div>
              </div>
          </div>
          <div id="showData">
              <section id="top">
                  <div id="piechooser" class="panel">
                    <select onchange='setSelectedSeq(this.value);' id="reference-select">

                      <option value="all">all</option>
                    </select>
                  </div>
                  <div id="depth-distribution" class="panel">

                      <div class="title">Read Coverage</div>
                      <div class="hint">(drag to select region)</div>
                      <!-- <label class="checkbox" for="checkbox2" style="position:absolute;right:15px;top:21px;cursor:pointer" title="Turn on Exome Sampling - use the read coverage data to sample only regions with non-zero read depth">
                          <input type="checkbox"value="" class="outlier" data-toggle="checkbox" >
                          Exome
                      </label> -->
                      <input type="file" name="files[]" id="bedfile"  multiple />
                      <div id="remove-bedfile-button" class="bedfile-button" onClick="removeBedFile()" style="visibility:hidden">Remove Bed</div>
                      <div id="default-bedfile-button" class="bedfile-button" onClick="addDefaultBedFile()" title="1000G human exome targets file " style="right:110px">Default Bed</div>
                      <label id="add-bedfile-button" class="bedfile-button" for="bedfile" title="Add Bed format capture target definition file">Custom Bed</label>

                      <!-- log toggle -->
                      <label id="scale-switch" class="checkbox">
                              <input type="checkbox"value=""  class='power-scale' data-toggle="checkbox" >
                              Power Scale
                      </label>

                      <div id="readDepthLoadingMsg" style="font-size:50px;margin-top:30px;color:#2687BE">Initializing data <img style="height:18px" src="images/loading_dots.gif"/></div>
                      <div class='warning' id="not_enough_data">Bam file is too small to read coverage information</div>
                      <div class="warning too-many-refs">Too many references to display. Use the dropdown to the left to select the reference</div>
                      <!-- <div id="test-chart" style="width:100%"></div> -->
                      <div class='chart' style="width:98%; height:60%"></div>
                      <!-- <ul id="sequences"></ul> -->
                  </div>
                  <div id="total-reads" class="panel">
                      <div class="title">Reads Sampled</div>
                      <div id="value" style="font-size:5.5vw; color:#2687BE; text-align:center;padding-left:8px;">0</div>
                      <div id="base" style="font-size:1.4vw;padding-left:28px; letter-spacing:3px; color:#2687BE; text-align:center;">
                          <span id="number"></span>
                          <img title="Sample More" style="width:20px;margin-bottom:-3px;margin-left:-7px;cursor:pointer" onClick="sampleMore()"  src="images/more_sampling.png"></img>
                      </div>

                  </div>
              </section>
              <section id="middle">
                  <div id="percents">
                      <div id="mapped_reads" class="percent panel">Mapped Reads
                          <div class="samplingLoader">Sampling <img src="images/loading_dots.gif"/></div>
                          <div class='chart'></div>
                          <div class='from-index'>* full data available in index</div>
                      </div>
                      <div id="forward_strands" class="percent panel">Forward Strand
                          <div class="samplingLoader">Sampling <img src="images/loading_dots.gif"/></div>
                          <div class='chart'></div>
                      </div>
                      <div id="proper_pairs" class="percent panel">Proper Pairs
                          <div class="samplingLoader">Sampling <img src="images/loading_dots.gif"/></div>
                          <div class='chart'></div>
                      </div>
                      <div id="singletons" class="percent panel">Singletons
                          <div class="samplingLoader">Sampling <img src="images/loading_dots.gif"/></div>
                          <div class='chart'></div>
                      </div>
                      <div id="both_mates_mapped" class="percent panel">Both Pairs Mapped
                          <div class="samplingLoader">Sampling <img src="images/loading_dots.gif"/></div>
                          <div class='chart'></div>
                      </div>
                      <div id="duplicates" class="percent panel">Duplicates
                          <div class="samplingLoader">Sampling <img src="images/loading_dots.gif"/></div>
                          <div class='chart'></div>
                      </div>
                  </div>
                  <div id="distributions" >
                      <div id="read-coverage-distribution" class="distribution panel"><div>Read Coverage Distribution</div>
                          <div class="samplingLoader">Sampling <img src="images/loading_dots.gif"/></div>
                          <div id="read-coverage-distribution-chart" class="chart focus" preserveAspectRatio="none" style="width:98%;height:90%"></div>
                      </div>
                      <div id="length-distribution" class="distribution panel">
                          <div><div class="chart-chooser"><span class="selected" onclick="toggleChart(this,'lengthChart')" data-outlier="false" data-id="frag_hist">Insert Length</span> | <span onclick="toggleChart(this,'lengthChart')" data-id="length_hist" data-outlier="true">Read Length</span></div></div>
                          <label class="checkbox" for="checkbox2" style="position:absolute;right:10px;top:24px;cursor:pointer" >
                              <input type="checkbox"value="" class="outlier" data-toggle="checkbox" >
                              Outliers
                          </label>
                          <div class="samplingLoader">Sampling <img src="images/loading_dots.gif"/></div>
                          <div id="length-distribution-chart" class="chart focus" preserveAspectRatio="none" style="width:98%;height:85%"></div>
                      </div>
                      <div id="mapping-quality-distribution" class="distribution panel">
                          <div><div class="chart-chooser"><span onclick="toggleChart(this,'qualityChart')" data-id="mapq_hist" class="selected">Mapping Quality</span> | <span data-id="baseq_hist" onclick="toggleChart(this,'qualityChart')">Base Quality</span></div></div>
                          <div class="samplingLoader">Sampling <img src="images/loading_dots.gif"/></div>
                          <div id="mapping-quality-distribution-chart" class="chart focus" preserveAspectRatio="none" style="width:98%;height:90%"></div>
                      </div>
                  </div>
              </section>
          </div>
        </div>
        <script src="js/flatui-checkbox.js"></script>
        <script>
            var div = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 1);
        </script>
    </body>
</html>